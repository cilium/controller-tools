From ce44dda0cbcec060fe1b3ca9801280ce04bb999f Mon Sep 17 00:00:00 2001
From: Matt Ellison <matt@arroyo.io>
Date: Tue, 6 Aug 2019 09:25:28 -0400
Subject: [PATCH 2/4] Support for oneOf Groups for Discriminate Types

Signed-off-by: Chris Tarazi <tarazichris@gmail.com>
---
 pkg/crd/markers/validation.go |  3 +++
 pkg/crd/schema.go             | 19 +++++++++++++++----
 2 files changed, 18 insertions(+), 4 deletions(-)

diff --git a/pkg/crd/markers/validation.go b/pkg/crd/markers/validation.go
index b20ff162..722e54ca 100644
--- a/pkg/crd/markers/validation.go
+++ b/pkg/crd/markers/validation.go
@@ -79,6 +79,9 @@ var FieldOnlyMarkers = []*definitionWithHelp{
 	must(markers.MakeDefinition("optional", markers.DescribesField, struct{}{})).
 		WithHelp(markers.SimpleHelp("CRD validation", "specifies that this field is optional, if fields are required by default.")),
 
+	must(markers.MakeDefinition("kubebuilder:validation:OneOf", markers.DescribesField, struct{}{})).
+		WithHelp(markers.SimpleHelp("CRD validation", "specifies that this field is part of a oneOf group")),
+
 	must(markers.MakeDefinition("nullable", markers.DescribesField, Nullable{})).
 		WithHelp(Nullable{}.Help()),
 
diff --git a/pkg/crd/schema.go b/pkg/crd/schema.go
index 4c7d5e9b..4b52ba25 100644
--- a/pkg/crd/schema.go
+++ b/pkg/crd/schema.go
@@ -376,6 +376,10 @@ func structToSchema(ctx *schemaContext, structType *ast.StructType) *apiext.JSON
 		fieldName := jsonOpts[0]
 		inline = inline || fieldName == "" // anonymous fields are inline fields in YAML/JSON
 
+		fieldMarkedOptional := (field.Markers.Get("kubebuilder:validation:Optional") != nil || field.Markers.Get("optional") != nil)
+		fieldMarkedRequired := (field.Markers.Get("kubebuilder:validation:Required") != nil)
+		fieldMarkedOneOf := (field.Markers.Get("kubebuilder:validation:OneOf") != nil)
+
 		// if no default required mode is set, default to required
 		defaultMode := "required"
 		if ctx.PackageMarkers.Get("kubebuilder:validation:Optional") != nil {
@@ -385,15 +389,15 @@ func structToSchema(ctx *schemaContext, structType *ast.StructType) *apiext.JSON
 		switch defaultMode {
 		// if this package isn't set to optional default...
 		case "required":
-			// ...everything that's not inline, omitempty, or explicitly optional is required
-			if !inline && !omitEmpty && field.Markers.Get("kubebuilder:validation:Optional") == nil && field.Markers.Get("optional") == nil {
+			// ...everything that's not inline, not omitempty, not part of a oneOf group, and not explicitly optional is required
+			if !inline && !omitEmpty && !fieldMarkedOneOf && !fieldMarkedOptional {
 				props.Required = append(props.Required, fieldName)
 			}
 
 		// if this package isn't set to required default...
 		case "optional":
-			// ...everything that isn't explicitly required is optional
-			if field.Markers.Get("kubebuilder:validation:Required") != nil {
+			// ...everything that's part of a oneOf group, or not explicitly required is optional
+			if !fieldMarkedOneOf && fieldMarkedRequired {
 				props.Required = append(props.Required, fieldName)
 			}
 		}
@@ -404,6 +408,13 @@ func structToSchema(ctx *schemaContext, structType *ast.StructType) *apiext.JSON
 		} else {
 			propSchema = typeToSchema(ctx.ForInfo(&markers.TypeInfo{}), field.RawField.Type)
 		}
+		// process oneOf groups
+		if fieldMarkedOneOf {
+			props.OneOf = append(props.OneOf, apiext.JSONSchemaProps{
+				Properties: map[string]apiext.JSONSchemaProps{fieldName: {}},
+				Required:   []string{fieldName},
+			})
+		}
 		propSchema.Description = field.Doc
 
 		applyMarkers(ctx, field.Markers, propSchema, field.RawField)
-- 
2.41.0

